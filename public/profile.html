<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile - Curly Fiesta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .url-link { color: #3b82f6; text-decoration: none; }
        .url-link:hover { text-decoration: underline; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <div id="profile-display" class="bg-white p-8 rounded-lg shadow-md max-w-md mx-auto">
            </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-lg">
            <h2 class="text-xl font-bold mb-4">Edit Profile</h2>
            <form id="edit-profile-form">
                <div class="mb-4">
                    <label for="edit-username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input id="edit-username" type="text" class="mt-1 block w-full p-2 border rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="edit-bio" class="block text-sm font-medium text-gray-700">Bio</label>
                    <textarea id="edit-bio" rows="3" class="mt-1 block w-full p-2 border rounded-md"></textarea>
                </div>
                <div class="mb-4">
                    <label for="edit-pfp" class="block text-sm font-medium text-gray-700">New Profile Picture (Optional)</label>
                    <input id="edit-pfp" type="file" accept="image/*" class="mt-1 block w-full text-sm">
                </div>
                <div id="url-fields-container" class="mb-4 space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Links</label>
                    </div>
                <button type="button" id="add-url-btn" class="text-sm text-blue-600 font-semibold mb-4">+ Add Link</button>
                <div class="flex justify-end space-x-2">
                    <button id="cancel-edit-btn" type="button" class="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button>
                    <button id="save-edit-btn" type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const profileDisplay = document.getElementById('profile-display');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-profile-form');

        let currentUserData = null;

        function renderProfile(user) {
            currentUserData = user; // Store the latest user data
            const urls = user.urls ? JSON.parse(user.urls) : [];
            const urlsHTML = urls.map(item => `
                <div class="mb-1"><a href="${item.value}" target="_blank" rel="noopener noreferrer" class="url-link">${item.label}</a></div>
            `).join('');

            profileDisplay.innerHTML = `
                <img src="${user.profile_picture_url || 'https://via.placeholder.com/150'}" alt="Profile Picture" class="w-32 h-32 rounded-full mx-auto mb-4 object-cover">
                <h1 class="text-3xl font-bold text-center">${user.username}</h1>
                <p class="text-gray-600 text-center mt-1">Member since: ${new Date(user.created_at).toLocaleDateString()}</p>
                <div class="mt-4 text-center">
                    <button id="edit-profile-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold text-sm hover:bg-indigo-700">Edit Profile</button>
                </div>
                ${user.bio ? `<p class="mt-6 text-gray-800 whitespace-pre-wrap">${user.bio}</p>` : ''}
                ${urlsHTML ? `<div class="mt-6 border-t pt-4">${urlsHTML}</div>` : ''}
                <div class="text-center mt-6"><a href="/" class="text-indigo-600">Go to Home</a></div>
            `;
            
            // Add event listener to the newly rendered edit button
            document.getElementById('edit-profile-btn').addEventListener('click', openEditModal);
        }

        function openEditModal() {
            if (!currentUserData) return;

            document.getElementById('edit-username').value = currentUserData.username || '';
            document.getElementById('edit-bio').value = currentUserData.bio || '';
            document.getElementById('edit-pfp').value = ''; // Clear file input
            
            const urlContainer = document.getElementById('url-fields-container');
            urlContainer.innerHTML = '<label class="block text-sm font-medium text-gray-700">Links</label>';
            const urls = currentUserData.urls ? JSON.parse(currentUserData.urls) : [];
            urls.forEach(createUrlInput);

            editModal.classList.remove('hidden');
            editModal.classList.add('flex');
        }

        function createUrlInput(item = { label: '', value: '' }) {
            const container = document.getElementById('url-fields-container');
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2';
            div.innerHTML = `
                <input type="text" placeholder="Label (e.g., Website)" class="w-1/3 p-2 border rounded-md" value="${item.label}">
                <input type="url" placeholder="URL (e.g., https://...)" class="flex-1 p-2 border rounded-md" value="${item.value}">
                <button type="button" class="text-red-500 font-bold remove-url-btn">&times;</button>
            `;
            container.appendChild(div);
            div.querySelector('.remove-url-btn').addEventListener('click', () => div.remove());
        }

        document.getElementById('add-url-btn').addEventListener('click', () => createUrlInput());
        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
            editModal.classList.add('hidden');
            editModal.classList.remove('flex');
        });

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('action', 'update-profile');
            formData.append('username', document.getElementById('edit-username').value);
            formData.append('bio', document.getElementById('edit-bio').value);
            
            const pfpFile = document.getElementById('edit-pfp').files[0];
            if (pfpFile) formData.append('profilePicture', pfpFile);

            const urls = [];
            document.querySelectorAll('#url-fields-container > div').forEach(div => {
                const label = div.children[0].value.trim();
                const value = div.children[1].value.trim();
                if (label && value) urls.push({ label, value });
            });
            formData.append('urls', JSON.stringify(urls));

            try {
                const response = await fetch('/api/profile', {
                    method: 'POST',
                    body: formData
                });
                if (response.ok) {
                    editModal.classList.add('hidden');
                    editModal.classList.remove('flex');
                    loadProfile(); // Reload profile to show changes
                } else {
                    const result = await response.json();
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Failed to update profile', error);
                alert('An error occurred while saving.');
            }
        });

        async function loadProfile() {
            try {
                const response = await fetch('/api/profile?action=get-profile');
                if (response.status === 401) {
                    window.location.href = '/login.html';
                    return;
                }
                const result = await response.json();
                if (response.ok) {
                    renderProfile(result.user);
                }
            } catch (error) {
                console.error('Failed to load profile', error);
                profileDisplay.innerHTML = `<p class="text-red-500 text-center">Could not load profile.</p>`;
            }
        }
        
        loadProfile();
    </script>
</body>
</html>