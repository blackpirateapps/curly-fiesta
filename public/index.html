<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tiny Threads</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white border-b">
    <div class="max-w-3xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold">Tiny Threads</h1>
      <span class="text-xs text-gray-500">Vercel + Turso (No login)</span>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1">
    <div class="max-w-3xl mx-auto px-4 py-6 space-y-6">
      <!-- Create Post -->
      <section class="bg-white rounded-xl shadow-sm border p-4">
        <form id="postForm" enctype="multipart/form-data" class="space-y-3">
          <textarea name="content" id="postContent" rows="3" required
            class="w-full p-3 border rounded-lg outline-none focus:ring focus:ring-blue-200"
            placeholder="What's on your mind?"></textarea>

          <div class="flex items-center gap-3">
            <input type="file" name="image" accept="image/*"
              class="block w-full text-sm text-gray-600 border rounded-lg file:mr-4 file:py-2 file:px-3 file:rounded-lg file:border-0 file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200" />
            <button type="submit"
              class="shrink-0 inline-flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-white font-medium hover:bg-blue-700">
              Post
            </button>
          </div>
        </form>
      </section>

      <!-- Feed -->
      <section class="space-y-4" id="posts"></section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t">
    <div class="max-w-3xl mx-auto px-4 py-4 text-center text-xs text-gray-500">
      ¬© 2025 Tiny Threads
    </div>
  </footer>

  <script>
    // ---------- Utilities ----------
    const $ = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => [...root.querySelectorAll(q)];
    const escapeHTML = (str) => (str ?? "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");

    // ---------- API wrappers ----------
    async function apiLike(targetId, type) {
      await fetch('/api/like', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ targetId, type })
      });
    }
    async function apiCreatePost(formData) {
      await fetch('/api/createPost', { method: 'POST', body: formData });
    }
    async function apiCreateComment(formData) {
      await fetch('/api/comment', { method: 'POST', body: formData });
    }
    async function apiGetPosts() {
      const r = await fetch('/api/getPosts');
      return r.json();
    }
    async function apiGetComments(postId) {
      const r = await fetch(`/api/comment?postId=${encodeURIComponent(postId)}`);
      return r.json();
    }

    // ---------- Rendering ----------
    async function loadPosts() {
      const posts = await apiGetPosts();
      const container = $('#posts');
      container.innerHTML = '';

      posts.forEach(post => {
        const card = document.createElement('article');
        card.className = 'bg-white rounded-xl shadow-sm border p-4';
        card.innerHTML = renderPostHTML(post);
        container.appendChild(card);

        // Wire up like
        $('.btn-like-post', card)?.addEventListener('click', async () => {
          await apiLike(post.id, 'post');
          await refreshPost(card, post.id);
        });

        // Wire up toggle comment form
        $('.btn-toggle-comment', card)?.addEventListener('click', () => {
          $('#commentForm-' + post.id, card)?.classList.toggle('hidden');
        });

        // Wire up submit comment
        $('#commentForm-' + post.id, card)?.addEventListener('submit', async (e) => {
          e.preventDefault();
          const fd = new FormData(e.target);
          fd.append('postId', post.id);
          await apiCreateComment(fd);
          e.target.reset();
          await renderCommentsInto($('#comments-' + post.id, card), post.id);
        });

        // Load comments thread
        renderCommentsInto($('#comments-' + post.id, card), post.id);
      });
    }

    function renderPostHTML(post) {
      return `
        <div class="space-y-3">
          <div class="whitespace-pre-wrap">${escapeHTML(post.content)}</div>
          ${post.image_url ? `<img src="${post.image_url}" alt="post image" class="w-full rounded-lg">` : ''}
          <div class="flex items-center gap-4 text-sm text-gray-600">
            <button class="btn-like-post hover:text-blue-600 inline-flex items-center gap-1">‚ù§Ô∏è <span>${post.likes ?? 0}</span></button>
            <button class="btn-toggle-comment hover:text-blue-600 inline-flex items-center gap-1">üí¨ Comment</button>
          </div>

          <!-- New comment form -->
          <form id="commentForm-${post.id}" class="hidden mt-2 space-y-2" enctype="multipart/form-data">
            <textarea name="content" rows="2" required
              class="w-full p-2 border rounded-lg outline-none focus:ring focus:ring-blue-200"
              placeholder="Write a comment..."></textarea>
            <div class="flex items-center gap-2">
              <input type="file" name="image" accept="image/*"
                class="block w-full text-sm text-gray-600 border rounded-lg file:mr-4 file:py-1.5 file:px-3 file:rounded-lg file:border-0 file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200" />
              <button class="shrink-0 bg-gray-900 text-white px-3 py-1.5 rounded-lg hover:bg-black">Reply</button>
            </div>
          </form>

          <!-- Comments container -->
          <div id="comments-${post.id}" class="mt-3 space-y-3"></div>
        </div>
      `;
    }

    async function renderCommentsInto(rootEl, postId) {
      const flat = await apiGetComments(postId);
      const tree = buildTree(flat);
      rootEl.innerHTML = '';
      tree.forEach(node => rootEl.appendChild(renderCommentNode(node, postId, 0)));
    }

    // Build tree from flat comments using parent_id
    function buildTree(comments) {
      const byId = new Map();
      comments.forEach(c => byId.set(c.id, { ...c, children: [] }));
      const roots = [];
      byId.forEach(node => {
        if (node.parent_id) {
          const parent = byId.get(node.parent_id);
          if (parent) parent.children.push(node);
          else roots.push(node); // orphan safety
        } else {
          roots.push(node);
        }
      });
      return roots;
    }

    function renderCommentNode(node, postId, depth) {
      const wrap = document.createElement('div');
      wrap.className = `${depth ? 'pl-4 border-l-2 border-gray-200' : ''}`;

      const block = document.createElement('div');
      block.className = 'bg-gray-50 rounded-lg p-3';
      block.innerHTML = `
        <div class="whitespace-pre-wrap text-sm">${escapeHTML(node.content)}</div>
        ${node.image_url ? `<img src="${node.image_url}" alt="comment image" class="w-full rounded-lg mt-2">` : ''}
        <div class="mt-2 flex items-center gap-3 text-xs text-gray-600">
          <button class="btn-like-comment hover:text-blue-600 inline-flex items-center gap-1" data-id="${node.id}">‚ù§Ô∏è <span>${node.likes ?? 0}</span></button>
          <button class="btn-toggle-reply hover:text-blue-600 inline-flex items-center gap-1" data-id="${node.id}">‚Ü©Ô∏è Reply</button>
        </div>
        <form id="replyForm-${node.id}" class="hidden mt-2 space-y-2" enctype="multipart/form-data">
          <textarea name="content" rows="2" required
            class="w-full p-2 border rounded-lg outline-none focus:ring focus:ring-blue-200"
            placeholder="Write a reply..."></textarea>
          <div class="flex items-center gap-2">
            <input type="file" name="image" accept="image/*"
              class="block w-full text-sm text-gray-600 border rounded-lg file:mr-4 file:py-1.5 file:px-3 file:rounded-lg file:border-0 file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200" />
            <button class="shrink-0 bg-gray-800 text-white px-3 py-1.5 rounded-lg hover:bg-gray-900">Reply</button>
          </div>
        </form>
      `;
      wrap.appendChild(block);

      // children container
      const kids = document.createElement('div');
      kids.className = 'mt-2 space-y-2';
      wrap.appendChild(kids);

      // Wire up like for comment
      $('.btn-like-comment', block)?.addEventListener('click', async () => {
        await apiLike(node.id, 'comment');
        await renderCommentsInto(wrap.parentElement, postId); // re-render this post's comments
      });

      // Toggle reply form
      $('.btn-toggle-reply', block)?.addEventListener('click', () => {
        $('#replyForm-' + node.id, block)?.classList.toggle('hidden');
      });

      // Submit reply
      $('#replyForm-' + node.id, block)?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        fd.append('postId', postId);
        fd.append('parentId', node.id);
        await apiCreateComment(fd);
        e.target.reset();
        await renderCommentsInto(wrap.parentElement, postId);
      });

      // Render children
      (node.children || []).forEach(child => {
        kids.appendChild(renderCommentNode(child, postId, depth + 1));
      });

      return wrap;
    }

    async function refreshPost(cardEl, postId) {
      // Re-fetch only this post + comments (simple approach: refresh all)
      await loadPosts();
    }

    // ---------- Submit Post ----------
    $('#postForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      await apiCreatePost(fd);
      e.target.reset();
      await loadPosts();
    });

    // ---------- Initial load ----------
    loadPosts();
  </script>
</body>
</html>