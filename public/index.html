<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini Forum</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">

  <div class="max-w-2xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4 text-center">Mini Forum</h1>

    <!-- New Post Form -->
    <form id="postForm" class="bg-white p-4 rounded-xl shadow mb-6">
      <textarea id="postText" placeholder="What's on your mind?" class="w-full p-2 border rounded mb-2"></textarea>
      <input type="file" id="postImage" accept="image/*" class="mb-2" />
      <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Post</button>
    </form>

    <!-- Posts Container -->
    <div id="posts"></div>
  </div>

  <script>
    // Load posts
    async function loadPosts() {
      const res = await fetch("/api/posts");
      const posts = await res.json();
      const container = document.getElementById("posts");
      container.innerHTML = "";

      posts.forEach(post => {
        const div = document.createElement("div");
        div.className = "bg-white p-4 rounded-xl shadow mb-4";

        div.innerHTML = `
          <p class="mb-2">${post.text}</p>
          ${post.image_url ? `<img src="${post.image_url}" class="w-full max-h-60 object-cover rounded mb-2">` : ""}
          <div class="flex gap-4 text-sm text-gray-600 mb-2">
            <button onclick="handleLike('post', ${post.id}, 'like')">‚ù§Ô∏è ${post.likes || 0}</button>
            <button onclick="toggleComments(${post.id})">üí¨ ${post.comments_count || 0}</button>
          </div>
          <div id="comments-${post.id}" class="ml-2 hidden"></div>
          <div id="comment-form-${post.id}" class="mt-2 hidden">
            <textarea id="comment-text-${post.id}" placeholder="Write a comment..." class="w-full p-2 border rounded mb-2"></textarea>
            <input type="file" id="comment-image-${post.id}" accept="image/*" class="mb-2"/>
            <button onclick="submitComment(${post.id})" class="bg-green-500 text-white px-3 py-1 rounded">Comment</button>
          </div>
        `;

        container.appendChild(div);
      });
    }

    // Handle likes
    async function handleLike(type, id, action) {
      await fetch("/api/like", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ type, id, action })
      });
      loadPosts();
    }

    // Toggle comments visibility
    async function toggleComments(postId) {
      const el = document.getElementById(`comments-${postId}`);
      const form = document.getElementById(`comment-form-${postId}`);
      if (el.classList.contains("hidden")) {
        el.classList.remove("hidden");
        form.classList.remove("hidden");
        renderComments(postId, null, el);
      } else {
        el.classList.add("hidden");
        form.classList.add("hidden");
      }
    }

    // Render comments recursively
    async function renderComments(postId, parentId, container) {
      const res = await fetch(`/api/comment?post_id=${postId}&parent_id=${parentId || ""}`);
      const comments = await res.json();
      container.innerHTML = "";

      for (const c of comments) {
        const div = document.createElement("div");
        div.className = "p-2 mb-2 bg-gray-100 rounded-lg";

        div.innerHTML = `
          <p>${c.text}</p>
          ${c.image_url ? `<img src="${c.image_url}" class="w-32 rounded mt-2">` : ""}
          <div class="flex gap-2 mt-1 text-sm text-gray-600">
            <button onclick="handleLike('comment', ${c.id}, 'like')">‚ù§Ô∏è ${c.likes || 0}</button>
            <button onclick="showReplyForm(${postId}, ${c.id})">Reply</button>
          </div>
          <div id="replies-${c.id}" class="ml-4"></div>
          <div id="reply-form-${c.id}" class="hidden mt-2">
            <textarea id="reply-text-${c.id}" placeholder="Write a reply..." class="w-full p-2 border rounded mb-2"></textarea>
            <input type="file" id="reply-image-${c.id}" accept="image/*" class="mb-2"/>
            <button onclick="submitComment(${postId}, ${c.id})" class="bg-blue-500 text-white px-3 py-1 rounded">Reply</button>
          </div>
        `;

        container.appendChild(div);

        // Load replies recursively
        const replyContainer = div.querySelector(`#replies-${c.id}`);
        await renderComments(postId, c.id, replyContainer);
      }
    }

    // Show reply form
    function showReplyForm(postId, commentId) {
      document.getElementById(`reply-form-${commentId}`).classList.toggle("hidden");
    }

    // Submit comment or reply
    async function submitComment(postId, parentId = null) {
      const textEl = parentId ? document.getElementById(`reply-text-${parentId}`) : document.getElementById(`comment-text-${postId}`);
      const fileEl = parentId ? document.getElementById(`reply-image-${parentId}`) : document.getElementById(`comment-image-${postId}`);
      
      const formData = new FormData();
      formData.append("post_id", postId);
      formData.append("text", textEl.value);
      if (parentId) formData.append("parent_id", parentId);
      if (fileEl.files.length > 0) formData.append("image", fileEl.files[0]);

      await fetch("/api/comment", {
        method: "POST",
        body: formData
      });

      textEl.value = "";
      fileEl.value = "";
      renderComments(postId, null, document.getElementById(`comments-${postId}`));
    }

    // New post submission
    document.getElementById("postForm").addEventListener("submit", async e => {
      e.preventDefault();
      const text = document.getElementById("postText").value;
      const image = document.getElementById("postImage").files[0];

      const formData = new FormData();
      formData.append("text", text);
      if (image) formData.append("image", image);

      await fetch("/api/createPost", {
        method: "POST",
        body: formData
      });

      document.getElementById("postText").value = "";
      document.getElementById("postImage").value = "";
      loadPosts();
    });

    loadPosts();
  </script>
</body>
</html>